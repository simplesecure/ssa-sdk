{"id":"Bzm7","dependencies":[{"name":"/Users/polluterofminds/Development/simpleid/ssa-sdk/package.json","includedInParent":true,"mtime":1584306008866},{"name":"/Users/polluterofminds/Development/simpleid/ssa-sdk/node_modules/orbit-db/package.json","includedInParent":true,"mtime":1582579778661},{"name":"ipfs-pubsub-1on1","loc":{"line":3,"column":24},"parent":"/Users/polluterofminds/Development/simpleid/ssa-sdk/node_modules/orbit-db/src/exchange-heads.js","resolved":"/Users/polluterofminds/Development/simpleid/ssa-sdk/node_modules/ipfs-pubsub-1on1/src/direct-channel.js"},{"name":"logplease","loc":{"line":5,"column":23},"parent":"/Users/polluterofminds/Development/simpleid/ssa-sdk/node_modules/orbit-db/src/exchange-heads.js","resolved":"/Users/polluterofminds/Development/simpleid/ssa-sdk/node_modules/logplease/src/index.js"}],"generated":{"js":"\"use strict\";const e=require(\"ipfs-pubsub-1on1\"),a=require(\"logplease\"),t=a.create(\"exchange-heads\",{color:a.Colors.Yellow});a.setLogLevel(\"ERROR\");const s=async e=>{if(!e||!e._cache)return[];return[...await e._cache.get(e.localHeadsPath)||[],...await e._cache.get(e.remoteHeadsPath)||[]]},n=async(a,n,r,o,c,d,i)=>{const l=e=>{const a=JSON.parse(e.data),{address:t,heads:s}=a;d(t,s)};let h=c(r);if(!h)try{t.debug(`Create a channel to ${r}`),(h=await e.open(a,r)).on(\"message\",l),t.debug(`Channel created to ${r}`),i(h)}catch(g){t.error(g)}await h.connect(),t.debug(`Connected to ${r}`);const u=await s(o(n));return t.debug(`Send latest heads of '${n}':\\n`,JSON.stringify(u.map(e=>e.hash),null,2)),u&&await h.send(JSON.stringify({address:n,heads:u})),h};module.exports=n;"},"sourceMaps":{"js":{"mappings":[{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":1,"column":0},"generated":{"line":1,"column":0}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":3,"column":0},"generated":{"line":1,"column":13}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"Channel","original":{"line":3,"column":6},"generated":{"line":1,"column":19}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"require","original":{"line":3,"column":16},"generated":{"line":1,"column":21}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":3,"column":24},"generated":{"line":1,"column":29}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"Logger","original":{"line":5,"column":6},"generated":{"line":1,"column":49}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"require","original":{"line":5,"column":15},"generated":{"line":1,"column":51}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":5,"column":23},"generated":{"line":1,"column":59}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"logger","original":{"line":6,"column":6},"generated":{"line":1,"column":72}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"Logger","original":{"line":6,"column":15},"generated":{"line":1,"column":74}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"create","original":{"line":6,"column":22},"generated":{"line":1,"column":76}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":6,"column":29},"generated":{"line":1,"column":83}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":6,"column":47},"generated":{"line":1,"column":100}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"color","original":{"line":6,"column":49},"generated":{"line":1,"column":101}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"Logger","original":{"line":6,"column":56},"generated":{"line":1,"column":107}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"Colors","original":{"line":6,"column":63},"generated":{"line":1,"column":109}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"Yellow","original":{"line":6,"column":70},"generated":{"line":1,"column":116}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"Logger","original":{"line":7,"column":0},"generated":{"line":1,"column":125}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"setLogLevel","original":{"line":7,"column":7},"generated":{"line":1,"column":127}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":7,"column":19},"generated":{"line":1,"column":139}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":9,"column":0},"generated":{"line":1,"column":148}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"getHeadsForDatabase","original":{"line":9,"column":6},"generated":{"line":1,"column":154}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":9,"column":28},"generated":{"line":1,"column":156}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":9,"column":28},"generated":{"line":1,"column":162}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":10,"column":6},"generated":{"line":1,"column":166}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"store","original":{"line":10,"column":8},"generated":{"line":1,"column":170}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"store","original":{"line":10,"column":17},"generated":{"line":1,"column":174}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"_cache","original":{"line":10,"column":23},"generated":{"line":1,"column":176}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":10,"column":32},"generated":{"line":1,"column":183}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":10,"column":39},"generated":{"line":1,"column":189}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":13,"column":9},"generated":{"line":1,"column":192}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":13,"column":9},"generated":{"line":1,"column":198}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"store","original":{"line":11,"column":27},"generated":{"line":1,"column":208}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"_cache","original":{"line":11,"column":33},"generated":{"line":1,"column":210}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"get","original":{"line":11,"column":40},"generated":{"line":1,"column":217}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"store","original":{"line":11,"column":44},"generated":{"line":1,"column":221}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"localHeadsPath","original":{"line":11,"column":50},"generated":{"line":1,"column":223}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":11,"column":69},"generated":{"line":1,"column":240}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"store","original":{"line":12,"column":28},"generated":{"line":1,"column":252}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"_cache","original":{"line":12,"column":34},"generated":{"line":1,"column":254}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"get","original":{"line":12,"column":41},"generated":{"line":1,"column":261}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"store","original":{"line":12,"column":45},"generated":{"line":1,"column":265}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"remoteHeadsPath","original":{"line":12,"column":51},"generated":{"line":1,"column":267}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":12,"column":71},"generated":{"line":1,"column":285}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"exchangeHeads","original":{"line":16,"column":6},"generated":{"line":1,"column":290}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":16,"column":22},"generated":{"line":1,"column":292}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"ipfs","original":{"line":16,"column":29},"generated":{"line":1,"column":298}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"address","original":{"line":16,"column":35},"generated":{"line":1,"column":300}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"peer","original":{"line":16,"column":44},"generated":{"line":1,"column":302}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"getStore","original":{"line":16,"column":50},"generated":{"line":1,"column":304}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"getDirectConnection","original":{"line":16,"column":60},"generated":{"line":1,"column":306}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"onMessage","original":{"line":16,"column":81},"generated":{"line":1,"column":308}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"onChannelCreated","original":{"line":16,"column":92},"generated":{"line":1,"column":310}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"_handleMessage","original":{"line":17,"column":8},"generated":{"line":1,"column":315}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"_handleMessage","original":{"line":17,"column":8},"generated":{"line":1,"column":321}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"message","original":{"line":17,"column":25},"generated":{"line":1,"column":323}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"msg","original":{"line":18,"column":10},"generated":{"line":1,"column":327}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"msg","original":{"line":18,"column":10},"generated":{"line":1,"column":333}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"JSON","original":{"line":18,"column":16},"generated":{"line":1,"column":335}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"parse","original":{"line":18,"column":21},"generated":{"line":1,"column":340}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"message","original":{"line":18,"column":27},"generated":{"line":1,"column":346}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"data","original":{"line":18,"column":35},"generated":{"line":1,"column":348}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":19,"column":10},"generated":{"line":1,"column":355}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"address","original":{"line":19,"column":12},"generated":{"line":1,"column":363}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":19,"column":10},"generated":{"line":1,"column":365}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"heads","original":{"line":19,"column":21},"generated":{"line":1,"column":371}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"msg","original":{"line":19,"column":31},"generated":{"line":1,"column":374}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"onMessage","original":{"line":20,"column":4},"generated":{"line":1,"column":376}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"address","original":{"line":20,"column":14},"generated":{"line":1,"column":378}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"heads","original":{"line":20,"column":23},"generated":{"line":1,"column":380}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"channel","original":{"line":23,"column":6},"generated":{"line":1,"column":384}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"channel","original":{"line":23,"column":6},"generated":{"line":1,"column":388}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"getDirectConnection","original":{"line":23,"column":16},"generated":{"line":1,"column":390}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"peer","original":{"line":23,"column":36},"generated":{"line":1,"column":392}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":24,"column":6},"generated":{"line":1,"column":395}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"channel","original":{"line":24,"column":7},"generated":{"line":1,"column":399}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":25,"column":8},"generated":{"line":1,"column":401}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"logger","original":{"line":26,"column":6},"generated":{"line":1,"column":405}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"debug","original":{"line":26,"column":13},"generated":{"line":1,"column":407}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"peer","original":{"line":26,"column":42},"generated":{"line":1,"column":436}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"channel","original":{"line":27,"column":6},"generated":{"line":1,"column":442}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"Channel","original":{"line":27,"column":22},"generated":{"line":1,"column":450}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"open","original":{"line":27,"column":30},"generated":{"line":1,"column":452}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"ipfs","original":{"line":27,"column":35},"generated":{"line":1,"column":457}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"peer","original":{"line":27,"column":41},"generated":{"line":1,"column":459}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"on","original":{"line":28,"column":14},"generated":{"line":1,"column":463}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":28,"column":17},"generated":{"line":1,"column":466}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"_handleMessage","original":{"line":28,"column":28},"generated":{"line":1,"column":476}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"logger","original":{"line":29,"column":6},"generated":{"line":1,"column":479}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"debug","original":{"line":29,"column":13},"generated":{"line":1,"column":481}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"peer","original":{"line":29,"column":41},"generated":{"line":1,"column":509}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"onChannelCreated","original":{"line":30,"column":6},"generated":{"line":1,"column":514}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"channel","original":{"line":30,"column":23},"generated":{"line":1,"column":516}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":31,"column":6},"generated":{"line":1,"column":519}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"e","original":{"line":31,"column":13},"generated":{"line":1,"column":525}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"logger","original":{"line":32,"column":6},"generated":{"line":1,"column":528}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"error","original":{"line":32,"column":13},"generated":{"line":1,"column":530}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"e","original":{"line":32,"column":19},"generated":{"line":1,"column":536}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"channel","original":{"line":37,"column":8},"generated":{"line":1,"column":545}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"connect","original":{"line":37,"column":16},"generated":{"line":1,"column":547}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"logger","original":{"line":38,"column":2},"generated":{"line":1,"column":557}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"debug","original":{"line":38,"column":9},"generated":{"line":1,"column":559}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"peer","original":{"line":38,"column":31},"generated":{"line":1,"column":581}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"heads","original":{"line":41,"column":8},"generated":{"line":1,"column":586}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"heads","original":{"line":41,"column":8},"generated":{"line":1,"column":592}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"getHeadsForDatabase","original":{"line":41,"column":22},"generated":{"line":1,"column":600}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"getStore","original":{"line":41,"column":42},"generated":{"line":1,"column":602}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"address","original":{"line":41,"column":51},"generated":{"line":1,"column":604}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"channel","original":{"line":47,"column":9},"generated":{"line":1,"column":608}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"logger","original":{"line":42,"column":2},"generated":{"line":1,"column":615}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"debug","original":{"line":42,"column":9},"generated":{"line":1,"column":617}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"address","original":{"line":42,"column":40},"generated":{"line":1,"column":648}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"JSON","original":{"line":42,"column":55},"generated":{"line":1,"column":656}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"stringify","original":{"line":42,"column":60},"generated":{"line":1,"column":661}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"heads","original":{"line":42,"column":70},"generated":{"line":1,"column":671}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"map","original":{"line":42,"column":76},"generated":{"line":1,"column":673}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"e","original":{"line":42,"column":80},"generated":{"line":1,"column":677}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"e","original":{"line":42,"column":85},"generated":{"line":1,"column":680}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"hash","original":{"line":42,"column":87},"generated":{"line":1,"column":682}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":42,"column":94},"generated":{"line":1,"column":688}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":42,"column":100},"generated":{"line":1,"column":693}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"heads","original":{"line":43,"column":6},"generated":{"line":1,"column":697}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"channel","original":{"line":44,"column":10},"generated":{"line":1,"column":706}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"send","original":{"line":44,"column":18},"generated":{"line":1,"column":708}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"JSON","original":{"line":44,"column":23},"generated":{"line":1,"column":713}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"stringify","original":{"line":44,"column":28},"generated":{"line":1,"column":718}},{"source":"node_modules/orbit-db/src/exchange-heads.js","original":{"line":44,"column":38},"generated":{"line":1,"column":728}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"address","original":{"line":44,"column":40},"generated":{"line":1,"column":729}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"address","original":{"line":44,"column":49},"generated":{"line":1,"column":737}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"heads","original":{"line":44,"column":58},"generated":{"line":1,"column":739}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"heads","original":{"line":44,"column":65},"generated":{"line":1,"column":745}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"channel","original":{"line":47,"column":9},"generated":{"line":1,"column":750}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"module","original":{"line":50,"column":0},"generated":{"line":1,"column":753}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"exports","original":{"line":50,"column":7},"generated":{"line":1,"column":760}},{"source":"node_modules/orbit-db/src/exchange-heads.js","name":"exchangeHeads","original":{"line":50,"column":17},"generated":{"line":1,"column":768}}],"sources":{"node_modules/orbit-db/src/exchange-heads.js":"'use strict'\n\nconst Channel = require('ipfs-pubsub-1on1')\n\nconst Logger = require('logplease')\nconst logger = Logger.create('exchange-heads', { color: Logger.Colors.Yellow })\nLogger.setLogLevel('ERROR')\n\nconst getHeadsForDatabase = async store => {\n  if (!(store && store._cache)) return []\n  const localHeads = await store._cache.get(store.localHeadsPath) || []\n  const remoteHeads = await store._cache.get(store.remoteHeadsPath) || []\n  return [...localHeads, ...remoteHeads]\n}\n\nconst exchangeHeads = async (ipfs, address, peer, getStore, getDirectConnection, onMessage, onChannelCreated) => {\n  const _handleMessage = message => {\n    const msg = JSON.parse(message.data)\n    const { address, heads } = msg\n    onMessage(address, heads)\n  }\n\n  let channel = getDirectConnection(peer)\n  if (!channel) {\n    try {\n      logger.debug(`Create a channel to ${peer}`)\n      channel = await Channel.open(ipfs, peer)\n      channel.on('message', _handleMessage)\n      logger.debug(`Channel created to ${peer}`)\n      onChannelCreated(channel)\n    } catch (e) {\n      logger.error(e)\n    }\n  }\n\n  // Wait for the direct channel to be fully connected\n  await channel.connect()\n  logger.debug(`Connected to ${peer}`)\n\n  // Send the heads if we have any\n  const heads = await getHeadsForDatabase(getStore(address))\n  logger.debug(`Send latest heads of '${address}':\\n`, JSON.stringify(heads.map(e => e.hash), null, 2))\n  if (heads) {\n    await channel.send(JSON.stringify({ address: address, heads: heads }))\n  }\n\n  return channel\n}\n\nmodule.exports = exchangeHeads\n"},"lineCount":null}},"error":null,"hash":"b4c34226e507d6c5de7559cafb818f6e","cacheData":{"env":{}}}